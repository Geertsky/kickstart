#version=RHEL8

# Use text mode install and CDROM installation media
text
cdrom

# Disable the Setup Agent on first boot
firstboot --disable

# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'

# System language
lang en_US.UTF-8

# The root password is empty and locked by default
rootpw --lock --iscrypted locked

# Do not configure the X Window System
skipx

# System services
services --disabled="kdump" --enabled="NetworkManager,sshd"

# System timezone
timezone Europe/Zurich --utc

# Add a user that can login and escalate privileges, the password is "password".
user --name=linuxfabrik --groups=wheel --iscrypted --password=$6$YxsFrMkfy1PIRvCU$GJfIziATCSEOIaGLIrTa6aO1INNiNRforoW1k4N1AVju4FnCltEp6fOaq1GJdHTFaVuOmTpuTcrCAOXsXmtov1

# Configure firewall settings for the system
# --enabled reject incoming connections that are not in response to outbound requests
# --ssh     allow sshd service through the firewall
firewall --enabled --ssh

# State of SELinux on the installed system
selinux --enforcing

ignoredisk --only-use=vda

# Do not remove any partitions, but initializes a disk (or disks) by creating a default disk label
clearpart --none --initlabel

# System bootloader configuration
bootloader --location=mbr --boot-drive=vda --append="audit=1 audit_backlog_limit=8192 slub_debug=P page_poison=1 vsyscall=none"

# Boot Partition: Manual Partitioning with BIOS-/Legacy-Boot and XFS, on one partition
part /boot --fstype="xfs" --ondisk=vda --size=1024

# OS Partition
part pv.01 --fstype="lvmpv" --ondisk=vda --size=1024 --grow
# mbr only supports disks <= 2TB. If the disk is larger, gpt is automatically used. However, when using bios boot and gpt, a boot partition is needed. This will be created here if necessary
%include /tmp/disk-part.ks

# LVM: Volume Group
volgroup rl --pesize=4096 pv.01

# LVM: LV - CIS-compliant (/home, /tmp, /var, /var/log, /var/log/audit and /var/tmp on their own partitions)
# all sizes are in MB
# the sizes of the LVM LV's below require a disk with 20 GB
# Anaconda creates the LVs in reverse order; LVs listed at the end will be created first
logvol /home          --fstype="xfs"  --size=1024   --vgname=rl --name=home          --fsoptions="nodev"
logvol /var/log       --fstype="xfs"  --size=1024   --vgname=rl --name=var_log       --fsoptions="nodev,noexec,nosuid"
logvol /var/log/audit --fstype="xfs"  --size=512    --vgname=rl --name=var_log_audit --fsoptions="nodev,noexec,nosuid"
logvol /var           --fstype="xfs"  --size=4096   --vgname=rl --name=var           --fsoptions="nodev"
logvol /var/tmp       --fstype="xfs"  --size=1024   --vgname=rl --name=var_tmp       --fsoptions="nodev,noexec,nosuid"
logvol /tmp           --fstype="xfs"  --size=1024   --vgname=rl --name=tmp           --fsoptions="nodev,noexec,nosuid"
logvol /              --fstype="xfs"  --size=4096   --vgname=rl --name=root
logvol swap           --fstype="swap" --recommended --vgname=rl --name=swap

# Network information
network --bootproto=dhcp --device=link --activate --onboot=on --hostname=localhost.localdomain

# Shutdown after installation
shutdown

%packages
@core
# No need for plymouth. Also means anaconda won't put rhgb/quiet
# on kernel command line
-plymouth
%end

%addon com_redhat_kdump --disable
%end

%pre
#!/bin/sh
touch /tmp/disk-part.ks
# get disk size in GiB
DISKSIZE=`parted -sm /dev/vda unit GiB print | grep -e "/dev/vda:[0-9]*GiB" | cut -d: -f2 | sed -e 's/GiB$//'`
if [ ! -e /sys/firmware/efi ]; then
    # boot mode: BIOS
    if [ $DISKSIZE -gt 2000 ]; then
        # and GPT needed -> create biosboot
        echo "part biosboot --fstype=biosboot --size=1 --ondisk=vda" > /tmp/disk-part.ks
    fi
fi
%end

%post
# older versions of livecd-tools do not follow "rootpw --lock" line above
# https://bugzilla.redhat.com/show_bug.cgi?id=964299
passwd --delete root
passwd --lock root

#---- Install our SSH keys ----
mkdir -m0700 /home/linuxfabrik/.ssh/

cat <<EOF >/home/linuxfabrik/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDaWaDOEGqhZy1XD3a0IJKPvuB0wz2Yzc7Y8b2E91PPDSfi2wczUjZ9T2f8J7fw46i6O8dUFdsle8HePlVt1f6P+SPr84KIvte4sCXPGjHO7UlP+0biPl1FJbe+LU6akGVgAhc37CTn7h10COim5TpIdmPfn8A1y0Y8G3GNTVELSC4GG6rJLgme++OTkNlenH+L7KSobQE1v+MS4mRjrg+qitgPzBv1VgTWJff4d3vdEtb9zwVdzZzyXcdP5/nWH54iDaZawLsyvPXG2VDQq9bUn4CbZ+/ldrVg+yi8Y5RlSLFlbaX2XKnqf8mC3fpszXrmZ93d/idvCLDQ2ijV1FQzYLNg9nstV6VHCek1+g0u3oQ17CyRRCuxSRf3kDagO/+FMGwIliQTSX8rTx0epYzj4vUKA0nYIHXhwklUTG2PFNgJ1Nfxllqblij/PbFfoJCCp+st7/ewYYiclV6jrAg01/bqAvrdS8PW6JQpTIeuJRZhkrvCxgzDsuYE+EqTHxyBs7Uxu9D8QvgZEYiwuClRE92xPNmuEk/BDpX9s8mcXtamp57AUESRFWPFUZoDFuHRjHz56lXJ0UIfDR7XDZHumdQRt6jh7Sj0YGVN3Es9UIqka9dZRiXLdZ9q/C0IReZKtcKDSIn/xB1Kt2qAIRLpSG3IX8JmONOa1h/Gns1NKw== markus.frei@linuxfabrik.ch
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDixdI8HWcP4buCMgc5rIQwG40E2IlDZ2NZVYsnl6Ko5qunzCScRJlONr3T8rnwHHBVg16jXT3yc8Ib01BXarSz88FdAYbm2IDDIvD6Infm7OLx9uJmdX/h3/t063l2I4kbcLsXoDinUqWMHrLNqoXjzb6rPAudb0PQTFj0b/WM6SZio0tWZcATSfI5BMBg212Ni24FRN6Q1ql4p0aYw6w1dfnNFCuHD+3Sfpm8UN+kZZVXX0sw5hNdebLwbSmc+qnktPxklWr6WyW5vtHCP2+puWHEH34yzdoncxCE06Ce2C101EXAk0jSKaorWdy9fhIxJvMSZaQGvBtwINJ/GHFJu6Q63PeMKKNV/pgnVJwukdCG+DNb7UsZ+RlUjP1UvGOO2IvTwtyReKdZNrWeD8PDdWbztbh5TbNfHnOZYQhnPv/NoSLBcrieixyFZ/uujzy+pBrIu8aXZz7feZeOyY0b8dQKoPgBrJhCFccpdQOHdvldBLY8du+SI0qAV7Ch0R3kskRaGwV18KtPwVUfOVF1rMygJVPRrTdsiIAv4m0U33bx/MOmka9PbzgO3eeBiDGqGLQn1Ah/+2vjDJxlbmJa4Syojln240s3frFlUbVHzyyYSA8varu1SwO97BkRZd8ckDltTzpT3WKsmi9vbfho/opQu/L0NgX7+Tfi0EXLEQ== sandro.lang@linuxfabrik.ch
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDuYw1auj8Lo6l5Ie8H7q419pKNjD3LSDZpFLNI0KehO chris.drescher@linuxfabrik.ch
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM5DxWzuUlSfdHHE1c4oQ2cbC0TyjXkVCuNKBJvn7TvX navid.sassan@linuxfabrik.ch
EOF

### set permissions
chmod 0600 /home/linuxfabrik/.ssh/authorized_keys
chown -R linuxfabrik:linuxfabrik /home/linuxfabrik/.ssh

### fix up selinux context
restorecon -R /home/linuxfabrik/.ssh/
%end
